name: Benchmarks
on:
  workflow_dispatch:

concurrency: benchmarks

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π
      - uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          submodules: false
          
      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º Metro-Observers (–ª–æ–∫–∞–ª—å–Ω–æ)
      - name: Setup private submodules locally
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
          git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
          git submodule update --init --recursive
          
      - name: Get Engine version
        run: |
          cd RobustToolbox
          git fetch --depth=1
          echo "ENGINE_VERSION=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        id: engine_version
        
      # 3. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
      - name: Prepare token for remote server
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å —Ç–æ–∫–µ–Ω–æ–º (–±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
          echo 'PAT="${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}"' > remote_clone_script.sh
          echo 'if [ -n "$PAT" ]; then' >> remote_clone_script.sh
          echo '  echo "Setting up Git authentication for private submodules..."' >> remote_clone_script.sh
          echo '  git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"' >> remote_clone_script.sh
          echo 'fi' >> remote_clone_script.sh
          
      # 4. –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ–Ω—á–º–∞—Ä–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
      - name: Run script on centcomm
        uses: appleboy/ssh-action@master
        with:
          host: centcomm.spacestation14.io
          username: robust-benchmark-runner
          key: ${{ secrets.CENTCOMM_ROBUST_BENCHMARK_RUNNER_KEY }}
          command_timeout: 100000m
          script: |
            mkdir benchmark_run_content_${{ github.sha }}
            cd benchmark_run_content_${{ github.sha }}
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
            if [ -n "${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}" ]; then
              git config --global url."https://x-access-token:${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}@github.com".insteadOf "https://github.com"
            fi
            
            # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –ø–æ–¥–º–æ–¥—É–ª—è–º–∏
            echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
            git clone https://github.com/${{ github.repository }}.git repo_dir --recursive
            
            cd repo_dir
            git checkout ${{ github.sha }}
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π
            echo "üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–º–æ–¥—É–ª–µ–π..."
            git submodule sync
            git submodule update --init --recursive --force
            
            cd Content.Benchmarks
            dotnet restore
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è SQL
            export ROBUST_BENCHMARKS_ENABLE_SQL=1
            export ROBUST_BENCHMARKS_SQL_ADDRESS="${{ secrets.BENCHMARKS_WRITE_ADDRESS }}"
            export ROBUST_BENCHMARKS_SQL_PORT="${{ secrets.BENCHMARKS_WRITE_PORT }}"
            export ROBUST_BENCHMARKS_SQL_USER="${{ secrets.BENCHMARKS_WRITE_USER }}"
            export ROBUST_BENCHMARKS_SQL_PASSWORD="${{ secrets.BENCHMARKS_WRITE_PASSWORD }}"
            export ROBUST_BENCHMARKS_SQL_DATABASE="content_benchmarks"
            export GITHUB_SHA="${{ github.sha }}"
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ–Ω—á–º–∞—Ä–∫–∏..."
            dotnet run --filter '*' --configuration Release
            
            cd ../../..
            rm -rf benchmark_run_content_${{ github.sha }}
