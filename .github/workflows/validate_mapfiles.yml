name: Map file schema validator

on:
  push:
    branches: [ master, staging, stable ]
  merge_group:
  pull_request:
    types: [ opened, reopened, synchronize, ready_for_review ]
  workflow_dispatch: 

jobs:
  yaml-schema-validation:
    name: YAML map schema validator
    if: github.actor != 'PJBot' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞
    permissions:
      contents: read
      checks: write
    
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å —Ç–æ–∫–µ–Ω–æ–º
      - uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          submodules: false
          
      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º
      - name: Configure Git authentication for private submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
          if [ -z "$PAT" ]; then
            echo "–û–®–ò–ë–ö–ê: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "–î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç PRIVATE_SUBMODULE_TOKEN –∏–ª–∏ ORG_ACCESS_TOKEN"
            exit 1
          fi
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–º–µ–Ω—É URL –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ GitHub
          git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ Metro-Observers
          git config --global url."https://x-access-token:$PAT@github.com/Metro-Observers".insteadOf "https://github.com/Metro-Observers"
          
          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Git –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
          
      # 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏
      - name: Initialize and update submodules
        run: |
          echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ–¥–º–æ–¥—É–ª–µ–π
          echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–º–æ–¥—É–ª–µ–π:"
          git submodule status || true
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–¥–º–æ–¥—É–ª–∏
          git submodule sync
          git submodule update --init --recursive --force --depth=1
          
          echo "–ü–æ–¥–º–æ–¥—É–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –ø–æ–¥–º–æ–¥—É–ª–∏
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–º–æ–¥—É–ª–µ–π Metro14:"
          [ -d "Content.Client/_Metro14/.git" ] && echo "Client –ø–æ–¥–º–æ–¥—É–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "Client –ø–æ–¥–º–æ–¥—É–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          [ -d "Content.Server/_Metro14/.git" ] && echo "Server –ø–æ–¥–º–æ–¥—É–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "Server –ø–æ–¥–º–æ–¥—É–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          [ -d "Content.Shared/_Metro14/.git" ] && echo "Shared –ø–æ–¥–º–æ–¥—É–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "Shared –ø–æ–¥–º–æ–¥—É–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          
      # 4. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–º–æ–¥—É–ª—å RobustToolbox (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
      - name: Pull engine updates
        uses: space-wizards/submodule-dependency@v0.1.5
        with:
          github-token: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.GITHUB_TOKEN }}
          
          
      # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä YAML —Å—Ö–µ–º
      - uses: PaulRitter/yaml-schema-validator@v1
        with:
          schema: RobustToolbox/Schemas/mapfile.yml
          path_pattern: .*Resources/Maps/.*
          validators_path: RobustToolbox/Schemas/mapfile_validators.py
          validators_requirements: RobustToolbox/Schemas/mapfile_requirements.txt
